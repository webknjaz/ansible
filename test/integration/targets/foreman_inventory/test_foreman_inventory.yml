---
- hosts: localhost
  vars:
    foreman_stub_host: "{{ lookup('env', 'foreman_host') }}"
    foreman_stub_port: "{{ lookup('env', 'foreman_port') }}"
    foreman_stub_api_path: /api/v2
    foreman_stub_host_uri: "http://{{ foreman_stub_host }}:{{ foreman_stub_port }}"
    foreman_stub_api_uri: "{{ foreman_stub_host_uri }}{{ foreman_stub_api_path }}"
    foreman_stub_heartbeat_uri: "{{ foreman_stub_host_uri }}/ping"
  tasks:
  - debug:
      msg: >-
        Foreman host: {{ foreman_stub_host }} |
        Foreman port: {{ foreman_stub_port }} |
        API path: {{ foreman_stub_api_path }} |
        Foreman API URL: {{ foreman_stub_api_uri }}
  
  - name: Wait for Foreman API stub to come up online
    wait_for:
      host: "{{ foreman_stub_host }}"
      port: "{{ foreman_stub_port }}"
      state: started
  
  # smoke test that flask app is serving
  - name: Smoke test HTTP response from Foreman stub
    uri:
      url: "{{ foreman_stub_heartbeat_uri }}"
      return_content: yes
    register: heartbeat_resp
    failed_when: >
        heartbeat_resp.json.status != 'ok' or heartbeat_resp.json.response != 'pong'

  #### Testing start
  - debug:
      var: inventory_hostname
  - debug:
      var: vars
  
  #- debug:
  #    var: "hostvars[inventory_hostname]"
  #
  #- debug:
  #    var: vars
  
  #- name:
  #  assert:
  #### Testing end
